services:
  api:
    build: .
    container_name: fitcollector_api
    environment:
      # SQLAlchemy wants this format
      DATABASE_URL: postgresql+psycopg2://fit:fitpass@db:5432/fitcollector
      FIT_API_KEY: "fc_live_7f3c9b2a7b2c4a2f9c8d1d0d9b3a"
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped

  db:
    image: postgres:16
    container_name: fitcollector_db
    environment:
      POSTGRES_USER: fit
      POSTGRES_PASSWORD: fitpass
      POSTGRES_DB: fitcollector
    volumes:
      - fitcollector_pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fit -d fitcollector"]
      interval: 3s
      timeout: 3s
      retries: 20
    restart: unless-stopped

volumes:
  fitcollector_pgdata:
