<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rewards - StepCraft</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #E3F2FD 0%, #E8F5E9 100%);
            font-family: 'Roboto', Arial, sans-serif;
            color: #222;
        }
        .wrap {
            max-width: 1000px;
            margin: 36px auto;
            padding: 24px;
            background: white;
            border-radius: 20px;
            border: 2px solid #2E7D32;
            box-shadow: 0 8px 32px rgba(44, 67, 54, 0.18);
        }
        .tier-card {
            border: 1px solid #D5DADF;
            border-radius: 16px;
            padding: 14px;
            background: #F3F5F7;
            box-shadow: 0 6px 18px rgba(44, 67, 54, 0.10);
        }
        .tier-header {
            background: #ECEFF1;
            border: 1px solid #D5DADF;
            border-radius: 12px;
            padding: 8px 12px;
            margin-bottom: 12px;
        }
        .tier-card .form-label,
        .tier-card strong {
            color: #2E7D32;
        }
        .command-input {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
        .reward-item {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }
        .reward-item input {
            flex: 1;
        }
        .btn-danger {
            border: none;
        }
        textarea {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.95rem;
            min-height: 320px;
        }
        .title {
            font-family: 'Montserrat', monospace;
            color: #2E7D32;
            font-size: 1.6rem;
        }
        .btn-primary {
            background: linear-gradient(90deg, #1565C0 60%, #2E7D32 100%);
            border: none;
            font-weight: 500;
            transition: box-shadow 0.2s, transform 0.2s;
            box-shadow: 0 2px 8px rgba(44, 67, 54, 0.10);
        }
        .btn-primary:hover, .btn-primary:focus {
            background: linear-gradient(90deg, #2E7D32 60%, #1565C0 100%);
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 4px 16px rgba(44, 67, 54, 0.18);
        }
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #121212 0%, #1E1E1E 100%);
                color: #E1E1E1;
            }
            .wrap {
                background: #23272A;
                border: 2px solid #81C784;
                box-shadow: 0 8px 32px rgba(44, 67, 54, 0.32);
            }
            .tier-card {
                background: #000000;
                border-color: #2E7D32;
                box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
            }
            .tier-header {
                background: #1E1E1E;
                border-color: #2E7D32;
            }
            .reward-item input {
                background: #1E1E1E;
                color: #E1E1E1;
                border-color: #3C4043;
            }
            .tier-card .form-label,
            .tier-card strong {
                color: #81C784;
            }
            .form-control {
                background: #1E1E1E;
                color: #E1E1E1;
                border-color: #3C4043;
            }
            .form-control::placeholder {
                color: #A0AEC0;
            }
            .btn-outline-secondary {
                color: #E1E1E1;
                border-color: #81C784;
            }
            .btn-outline-secondary:hover, .btn-outline-secondary:focus {
                background: #2B2F33;
                border-color: #81C784;
                color: #E1E1E1;
            }
            .title {
                color: #81C784;
            }
            .btn-primary {
                background: linear-gradient(90deg, #64B5F6 60%, #81C784 100%);
                color: #23272A;
            }
            .btn-primary:hover, .btn-primary:focus {
                background: linear-gradient(90deg, #81C784 60%, #64B5F6 100%);
                color: #23272A;
            }
            pre,
            .bg-light {
                background: #1E1E1E !important;
                color: #E1E1E1;
                border-color: #3C4043 !important;
            }
        }
    </style>
</head>
<body>
    <div class="wrap">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="title">Reward Tiers {% if server_name %}Â· {{ server_name }}{% endif %}</div>
            <a class="btn btn-outline-secondary" href="/dashboard">Back</a>
        </div>

        {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
        {% endif %}

        {% if data %}
            <div class="mb-3">
                <div class="small text-muted">Server: {{ data.server_name }}{% if data.is_default %} (default){% endif %}</div>
            </div>
        {% endif %}

        <form id="rewards-form" method="post" action="/rewards/update?server={{ server_name }}">
            <input type="hidden" name="rewards_json" id="rewards_json">

            <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="form-label mb-0">Reward Tiers</label>
                <button class="btn btn-outline-secondary btn-sm" type="button" id="add-tier">Add Tier</button>
            </div>

            <div id="tiers-list" data-raw-json='{{ raw_json|tojson }}'>
                {% if data and data.tiers %}
                    {% for tier in data.tiers %}
                        <div class="tier-card mb-3" data-tier>
                            <div class="d-flex justify-content-between align-items-center tier-header">
                                <strong>Tier</strong>
                                <button class="btn btn-sm btn-outline-danger" type="button" data-remove-tier>Remove</button>
                            </div>
                            <div class="row g-2 mb-2">
                                <div class="col-md-4">
                                    <label class="form-label">Min Steps</label>
                                    <input class="form-control" type="number" min="0" step="1" data-min-steps value="{{ tier.min_steps }}">
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label">Label</label>
                                    <input class="form-control" type="text" data-label value="{{ tier.label }}">
                                </div>
                            </div>
                            <label class="form-label">Reward Commands</label>
                            <div data-rewards>
                                {% for reward in tier.rewards %}
                                    <div class="reward-item" data-reward>
                                        <input class="form-control command-input" type="text" value="{{ reward }}" placeholder="give {player} minecraft:diamond 1">
                                        <button class="btn btn-sm btn-outline-danger" type="button" data-remove-reward>Remove</button>
                                    </div>
                                {% endfor %}
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-add-reward>Add Reward Command</button>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>

            <div class="d-flex gap-2 mt-3">
                <button class="btn btn-primary" type="submit">Save</button>
                <button class="btn btn-outline-secondary" type="submit" form="default-rewards-form">Use Default</button>
            </div>
        </form>

        <form id="default-rewards-form" method="post" action="/rewards/default?server={{ server_name }}"></form>

        <hr>
        <h6>Examples</h6>
        <pre class="bg-light p-3 rounded small">Starter tier
 Min Steps: 1000
 Label: Starter
 Reward Commands:
  - give {player} minecraft:bread 3
  - say Congrats {player}!</pre>
    </div>
    <script>
        const tiersList = document.getElementById('tiers-list');
        const addTierBtn = document.getElementById('add-tier');

        function createRewardItem(value = '') {
            const row = document.createElement('div');
            row.className = 'reward-item';
            row.dataset.reward = 'true';
            row.innerHTML = `
                <input class="form-control command-input" type="text" placeholder="give {player} minecraft:diamond 1" value="${value.replace(/"/g, '&quot;')}">
                <button class="btn btn-sm btn-outline-danger" type="button" data-remove-reward>Remove</button>
            `;
            return row;
        }

        function createTierCard(tier = {}) {
            const card = document.createElement('div');
            card.className = 'tier-card mb-3';
            card.dataset.tier = 'true';
            card.innerHTML = `
                <div class="d-flex justify-content-between align-items-center tier-header">
                    <strong>Tier</strong>
                    <button class="btn btn-sm btn-outline-danger" type="button" data-remove-tier>Remove</button>
                </div>
                <div class="row g-2 mb-2">
                    <div class="col-md-4">
                        <label class="form-label">Min Steps</label>
                        <input class="form-control" type="number" min="0" step="1" data-min-steps value="${tier.min_steps ?? ''}">
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">Label</label>
                        <input class="form-control" type="text" data-label value="${(tier.label ?? '').replace(/"/g, '&quot;')}">
                    </div>
                </div>
                <label class="form-label">Reward Commands</label>
                <div data-rewards></div>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-add-reward>Add Reward Command</button>
            `;

            const rewardsWrap = card.querySelector('[data-rewards]');
            const rewards = Array.isArray(tier.rewards) ? tier.rewards : [];
            if (rewards.length === 0) {
                rewardsWrap.appendChild(createRewardItem(''));
            } else {
                rewards.forEach(r => rewardsWrap.appendChild(createRewardItem(r)));
            }
            return card;
        }

        function ensureAtLeastOneTier() {
            if (!tiersList.querySelector('[data-tier]')) {
                tiersList.appendChild(createTierCard());
            }
        }

        addTierBtn.addEventListener('click', () => {
            tiersList.appendChild(createTierCard());
        });

        tiersList.addEventListener('click', (event) => {
            if (event.target.matches('[data-remove-tier]')) {
                event.target.closest('[data-tier]').remove();
                ensureAtLeastOneTier();
            }
            if (event.target.matches('[data-add-reward]')) {
                const rewardsWrap = event.target.closest('[data-tier]').querySelector('[data-rewards]');
                rewardsWrap.appendChild(createRewardItem(''));
            }
            if (event.target.matches('[data-remove-reward]')) {
                const tier = event.target.closest('[data-tier]');
                const rewardsWrap = tier.querySelector('[data-rewards]');
                event.target.closest('[data-reward]').remove();
                if (!rewardsWrap.querySelector('[data-reward]')) {
                    rewardsWrap.appendChild(createRewardItem(''));
                }
            }
        });

        document.getElementById('rewards-form').addEventListener('submit', (event) => {
            const tiers = Array.from(tiersList.querySelectorAll('[data-tier]')).map(tierEl => {
                const minSteps = parseInt(tierEl.querySelector('[data-min-steps]').value || '0', 10);
                const label = tierEl.querySelector('[data-label]').value.trim();
                const rewards = Array.from(tierEl.querySelectorAll('[data-reward] input'))
                    .map(input => input.value.trim())
                    .filter(Boolean);
                return { min_steps: minSteps, label, rewards };
            }).filter(t => t.label || t.rewards.length > 0 || t.min_steps > 0);

            const payload = { tiers };
            document.getElementById('rewards_json').value = JSON.stringify(payload, null, 2);
        });

        (function initFromRawJson() {
            const raw = tiersList.dataset.rawJson;
            if (!raw) {
                ensureAtLeastOneTier();
                return;
            }
            try {
                const parsed = JSON.parse(raw);
                if (Array.isArray(parsed.tiers) && parsed.tiers.length > 0) {
                    if (!tiersList.querySelector('[data-tier]')) {
                        parsed.tiers.forEach(t => tiersList.appendChild(createTierCard(t)));
                    }
                } else if (!tiersList.querySelector('[data-tier]')) {
                    ensureAtLeastOneTier();
                }
            } catch {
                ensureAtLeastOneTier();
            }
        })();
    </script>
</body>
</html>
